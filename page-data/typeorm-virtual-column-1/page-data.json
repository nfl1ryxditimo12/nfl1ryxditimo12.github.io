{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/typeorm-virtual-column-1/",
    "result": {"data":{"cur":{"id":"726a4e0e-7e34-52ae-8aa8-65dfced5f446","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIklEQVQoz5WST0/CQBDF+9U9EWMgGEhM/ATejCetXLl556DZGv4WUiBuaCnddudn2gUsiRGcZHY3b2fevJldj9JEqg2rIf6gbrJ5LxekHveHeSKCFHmVIP4dol7YZBb9tXYk6hl5vXf3RY61tvIqr+aunuBVh3xP2Glj1YhVkrAIQ7ZlcDBCOrdnlR1IvSN7WbVxhSwj5qsV08mExBiKRQjNBlEU0e/36fV6+L6P1rryOI5PFR5ll0D7BjsPWccxyyhis9tRhFNoXZNZIZzN+AwCBoMBSZKQpinGmN9aNo6w20SUYq414+GQrMSUQrqtQ2OXtSy2cODbAxI8YQSydOsig0eH/+dRTornula1VK+58Mc4hRxnWJtlDftpZ6/kDPM3H6637KPjZfIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"typeorm.png\"\n        title=\"typeorm.png\"\n        src=\"/static/e4b90acf02bd52801818ca0004fdd1f1/37523/typeorm.png\"\n        srcset=\"/static/e4b90acf02bd52801818ca0004fdd1f1/e9ff0/typeorm.png 180w,\n/static/e4b90acf02bd52801818ca0004fdd1f1/f21e7/typeorm.png 360w,\n/static/e4b90acf02bd52801818ca0004fdd1f1/37523/typeorm.png 720w,\n/static/e4b90acf02bd52801818ca0004fdd1f1/00d43/typeorm.png 1000w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h2 id=\"ullia-hrefhttpsseongsumetypeorm-virtual-column-2-target_blanktypeorm-virtual-column-설정-2aliul\" style=\"position:relative;\"><a href=\"#ullia-hrefhttpsseongsumetypeorm-virtual-column-2-target_blanktypeorm-virtual-column-%EC%84%A4%EC%A0%95-2aliul\" aria-label=\"ullia hrefhttpsseongsumetypeorm virtual column 2 target_blanktypeorm virtual column 설정 2aliul permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><ul><li><a href=\"https://seongsu.me/typeorm-virtual-column-2\" target=\"_blank\">Typeorm Virtual Column 설정 (2)</a></li></ul></h2>\n<br/>\n<br/>\n<p>Typeorm을 사용하며 대부분 마음에 들었는데 한가지 딱 아쉬운 부분이 있다…<br/>\nMysql에서는 테이블에 특정 컬럼이 없어도 SELECT시에 새로 만들어 출력 할 수 있다.<br/>\n현재 Typeorm에 가상 컬럼 기능이 있긴 한데 원하는 목적과 좀 달라서 원하는 데이터를 가공 후 새로운 컬럼을 추가 해 return 받을 수 있게 가상 컬럼에 관해 포스팅 하려 한다.<br/></p>\n<blockquote>\n<p>Typeorm 버전 0.2.37에 가상컬럼 업데이트 될거라는 얘기가 있었지만 현재 0.2.41 버전까지 지원이 안되고 있다…</p>\n</blockquote>\n<br/>\n<h2 id=\"-가상-컬럼이란\" style=\"position:relative;\"><a href=\"#-%EA%B0%80%EC%83%81-%EC%BB%AC%EB%9F%BC%EC%9D%B4%EB%9E%80\" aria-label=\" 가상 컬럼이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎓 가상 컬럼이란?</h2>\n<br/>\n<p>Mysql 5.7 부터 지원되는 가상 컬럼은 가상의 컬럼을 둬서 수식과 조건문을 사용해 데이터의 가공 결과를 저장하는 것을 말한다. 사용 방법은 PERSISTENT(stored)와 VIRTUAL(generated-only)이라는 두 가지 타입이 존재하고 디폴트는 PERSISTENT 이다<br/>\nPERSISTENT virtual columns은 실제 데이터가 데이터베이스에 저장되는 특성을 갖게 되며, VIRTUAL virtual columns은 실제 데이터가 데이터베이스에 저장되지 않고 그때 그때 계산돼 보여주는 역할을 한다.<br/></p>\n<blockquote>\n<p>이 포스팅에서 사용하는 타입은 <strong>VIRTUAL</strong> 이다.</p>\n</blockquote>\n<br/>\n<h2 id=\"-데이터-조회\" style=\"position:relative;\"><a href=\"#-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A1%B0%ED%9A%8C\" aria-label=\" 데이터 조회 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 데이터 조회</h2>\n<br/>\n<p>예를들어 데이터베이스 각 행에 버스 정류소의 위도, 경도 값이 저장이 돼 있다.<br/></p>\n<pre class=\"language-plain\">\n<span style=\"color: red;\">현재 위치</span> : 37.57418192 127.015664 (롯데캐슬 천지인 정류소)\n\n<span style=\"color: skyblue;\">목표 정류소1</span> : 37.57198805 127.0117451 (동대문역 2번출구 정류소)\n<span style=\"color: skyblue;\">목표 정류소2</span> : 37.57578617 126.998124 (원남동 사거리 정류소)\n<span style=\"color: skyblue;\">목표 정류소3</span> : 37.58630021 126.9853527 (감사원 정류소)\n</pre>\n<p>여기서 현재 위치 좌표 기준 직선거리 2km 이내의 데이터만 조회하려 하며<br/>\n각 데이터마다 거리가 얼마나 차이 나는지 알 수 있게 <code class=\"language-text\">distance</code>라는 key를 가진 컬럼을 추가해 조회하려 한다고 가정해 보자.<br/></p>\n<br/>\n<h3 id=\"code-classlanguage-textentitiesstationstscode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textentitiesstationstscode\" aria-label=\"code classlanguage textentitiesstationstscode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@entities/stations.ts</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Entity<span class=\"token punctuation\">,</span> PrimaryGeneratedColumn<span class=\"token punctuation\">,</span> Column <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"typeorm\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Entity</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stations\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Stations</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">PrimaryGeneratedColumn</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Column</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"varchar\"</span><span class=\"token punctuation\">)</span>\n    station<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Column</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"double\"</span><span class=\"token punctuation\">)</span>\n    latitude<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Column</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"double\"</span><span class=\"token punctuation\">)</span>\n    longitude<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Data Mapper 형식으로 Entity를 생성한다.</p>\n</blockquote>\n<br/>\n<p>우선 위도, 경도 값을 <code class=\"language-text\">double</code>형식으로 갖는 Entity를 설정 해 준다.<br/>\n그 뒤 <code class=\"language-text\">getMany()</code>함수로 호출 할 때, <code class=\"language-text\">getRawMany()</code>함수로 호출 할 때를 나눠 예를 들어 보겠다.<br/></p>\n<blockquote>\n<p>float형식으로 정할 시 좌표가 소숫점 5자리부터 잘리는 현상이 발생하니 double로 설정해주자</p>\n</blockquote>\n<br/>\n<h3 id=\"code-classlanguage-textgetmany-사용-시code\" style=\"position:relative;\"><a href=\"#code-classlanguage-textgetmany-%EC%82%AC%EC%9A%A9-%EC%8B%9Ccode\" aria-label=\"code classlanguage textgetmany 사용 시code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">getMany() 사용 시</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getRepository <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"typeorm\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Stations <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@entities/stations\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n    lat: 37.57418192,\n    lon: 127.015664,\n    radius(기준 km): 2\n*/</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">findAroundLocation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>lat<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> lon<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> radius<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>Stations<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">createQueryBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stations\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">addSelect</span><span class=\"token punctuation\">(</span>\n                <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">6371 * acos(cos(radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lat<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) * cos(radians(latitude)) * cos(radians(longitude) - radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lon<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) + sin(radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lat<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) * sin(radians(latitude)))</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"distance\"</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">having</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">distance &lt;= </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>radius<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"distance\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ASC\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">getMany</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">findAroundLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p><strong><code class=\"language-text\">Return</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token punctuation\">[</span>\n    Stations <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        station<span class=\"token operator\">:</span> <span class=\"token string\">\"동대문역 2번출구 정류소\"</span><span class=\"token punctuation\">,</span>\n        latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57198805</span><span class=\"token punctuation\">,</span>\n        longitude<span class=\"token operator\">:</span> <span class=\"token number\">127.0117451</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Stations <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        station<span class=\"token operator\">:</span> <span class=\"token string\">\"원남동 사거리 정류소\"</span><span class=\"token punctuation\">,</span>\n        latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57578617</span><span class=\"token punctuation\">,</span>\n        longitude<span class=\"token operator\">:</span> <span class=\"token number\">126.998124</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<blockquote>\n<p>현재 좌표와 목표 정류소3의 좌표간 거리가 2km가 넘기 때문에 조회되지 않는다.<br/>\n실 거리가 약 3km (2.991km) 이기 때문이다.<br/></p>\n</blockquote>\n<br/>\n<p>분명 <code class=\"language-text\">addSelect()</code>함수에 두 좌표간 거리 구하는 공식과 컬럼명을 지정해 줬는데 결과에는 <code class=\"language-text\">distance</code>가 나오지 않는다.<br/>\n왜냐하면 DB에서 단일한 결과를 가져오는 <code class=\"language-text\">getMany()</code>함수의 특성상 쿼리문에서 적용한 데이터는 출력이 안되고 계산에만 사용이 된다.<br/></p>\n<br/>\n<h3 id=\"code-classlanguage-textgetrawmany-사용-시code\" style=\"position:relative;\"><a href=\"#code-classlanguage-textgetrawmany-%EC%82%AC%EC%9A%A9-%EC%8B%9Ccode\" aria-label=\"code classlanguage textgetrawmany 사용 시code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">getRawMany() 사용 시</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getRepository <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"typeorm\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Stations <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@entities/stations\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n    lat: 37.57418192,\n    lon: 127.015664,\n    radius(기준 km): 2\n*/</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">aroundStation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>lat<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> lon<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> radius<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>Stations<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">createQueryBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stations\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">addSelect</span><span class=\"token punctuation\">(</span>\n                <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">6371 * acos(cos(radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lat<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) * cos(radians(latitude)) * cos(radians(longitude) - radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lon<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) + sin(radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lat<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) * sin(radians(latitude)))</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"distance\"</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">having</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">distance &lt;= </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>radius<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"distance\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ASC\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">getRawMany</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">aroundStation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p><strong><code class=\"language-text\">Return</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token punctuation\">[</span>\n    Stations <span class=\"token punctuation\">{</span>\n        stations_id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        stations_station<span class=\"token operator\">:</span> <span class=\"token string\">\"동대문역 2번출구 정류소\"</span><span class=\"token punctuation\">,</span>\n        stations_latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57198805</span><span class=\"token punctuation\">,</span>\n        stations_longitude<span class=\"token operator\">:</span> <span class=\"token number\">127.0117451</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">0.4228400907307967</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Stations <span class=\"token punctuation\">{</span>\n        stations_id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        stations_station<span class=\"token operator\">:</span> <span class=\"token string\">\"원남동 사거리 정류소\"</span><span class=\"token punctuation\">,</span>\n        stations_latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57578617</span><span class=\"token punctuation\">,</span>\n        stations_longitude<span class=\"token operator\">:</span> <span class=\"token number\">126.998124</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">1.5482886513847316</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<blockquote>\n<p>distance는 킬로미터 기준으로 계산한 결과이다.</p>\n</blockquote>\n<br/>\n<p><code class=\"language-text\">getRawMany()</code>함수로 조회 시 원시 결과를 얻어오기 때문에 <code class=\"language-text\">addSelect()</code>함수에서 지정한 <code class=\"language-text\">distance</code>를 갖고올 수 있다.<br/>\n이 경우 Mysql 가상 컬럼과 매우 비슷한 결과를 도출할 수 있게 된다.<br/>\n하지만 객체 key에 stations_ 가 붙어 나오게 된다.<br/>\n이 경우는 <code class=\"language-text\">addSelect()</code>함수 호출 이전에 <code class=\"language-text\">select()</code>함수를 호출해 <code class=\"language-text\">alias</code>설정을 해주면 손쉽게 해결 가능하다.<br/></p>\n<br/>\n<br/>\n<p>이상 Mysql의 가상 컬럼을 비슷하게 구현할 수 있는 Typeorm의 기능을 포스팅 했다.<br/>\n다음 포스팅에서 왜 Custom Virtual Column을 사용해야 하는지 이유와 함께 포스팅 해야겠다.<br/></p>\n<br/>\n<h2 id=\"-참고-자료\" style=\"position:relative;\"><a href=\"#-%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C\" aria-label=\" 참고 자료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📚 참고 자료</h2>\n<blockquote>\n<p>Typeorm 공식 레퍼런스</p>\n</blockquote>\n<ul>\n<li><a href=\"https://typeorm.io\">https://typeorm.io</a></li>\n</ul>\n<br/>\n<br/>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#ullia-hrefhttpsseongsumetypeorm-virtual-column-2-target_blanktypeorm-virtual-column-%EC%84%A4%EC%A0%95-2aliul\"><ul><li><a href=\"https://seongsu.me/typeorm-virtual-column-2\" target=\"_blank\">Typeorm Virtual Column 설정 (2)</a></li></ul></a></p>\n</li>\n<li>\n<p><a href=\"#-%EA%B0%80%EC%83%81-%EC%BB%AC%EB%9F%BC%EC%9D%B4%EB%9E%80\">🎓 가상 컬럼이란?</a></p>\n</li>\n<li>\n<p><a href=\"#-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A1%B0%ED%9A%8C\">🤔 데이터 조회</a></p>\n<ul>\n<li><a href=\"#entitiesstationsts\"><code class=\"language-text\">@entities/stations.ts</code></a></li>\n<li><a href=\"#getmany-%EC%82%AC%EC%9A%A9-%EC%8B%9C\"><code class=\"language-text\">getMany() 사용 시</code></a></li>\n<li><a href=\"#getrawmany-%EC%82%AC%EC%9A%A9-%EC%8B%9C\"><code class=\"language-text\">getRawMany() 사용 시</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C\">📚 참고 자료</a></p>\n</li>\n</ul>\n</div>","excerpt":"Typeorm Virtual Column 설정 (2) Typeorm을 사용하며 대부분 마음에 들었는데 한가지 딱 아쉬운 부분이 있다…\nMysql에서는 테이블에 특정 컬럼이 없어도 SELECT시에 새로 만들어 출력 할 수 있다.\n현재 Typeorm에 가상 컬럼 기능이 있긴 한데 원하는 목적과 좀 달라서 원하는 데이터를 가공 후 새로운 컬럼을 추가 해 return 받을 수 있게 가상 컬럼에 관해 포스팅 하려 한다. Typeorm 버전 0.2.37에 가상컬럼 업데이트 될거라는 얘기가 있었지만 현재 0.2.41 버전까지 지원이 안되고 있다… 🎓 가상 컬럼이란? Mysql 5.7 부터 지원되는 가상 컬럼은 가상의 컬럼을 둬서 수식과 조건문을 사용해 데이터의 가공 결과를 저장하는 것을 말한다. 사용 방법은 PERSISTENT(stored)와 VIRTUAL(generated-only)이라는 두 가지 타입이 존재하고 디폴트는 PERSISTENT 이다\nPERSISTENT virtual column…","frontmatter":{"date":"January 15, 2022","title":"Typeorm Virtual Column 설정 (1)","categories":"Node.js Express","author":"seongsu","emoji":"9️⃣"},"fields":{"slug":"/typeorm-virtual-column-1/"}},"next":{"id":"0d46e7d8-88c4-58d6-8b77-a2753cfb0a17","html":"<p>오늘은 생소하고 아무도 사용 안하는 <code class=\"language-text\">Afterware</code> 개념을 도입해 모든 API 응답에 JWT가 만료되었다면 새로 발행해주는 코드 짜고자 한다.<br/>\n원래 Express에 <code class=\"language-text\">Middleware</code> 개념이 있고 실제로 지원이 된다.<br/>\n하지만 현재 구현하는 로직 상 <code class=\"language-text\">Afterware</code>를 사용하면 유지보수에 상당히 도움이 될 것 같다<br/></p>\n<br/>\n<h2 id=\"-afterware-란\" style=\"position:relative;\"><a href=\"#-afterware-%EB%9E%80\" aria-label=\" afterware 란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Afterware 란?</h2>\n<br/>\n<p>사실 Express 프레임워크에 <code class=\"language-text\">Afterware</code>란 기능은 없다<br/>\n그냥 맨 마지막에 실행되는 함수라 이렇게 부르는 것일 뿐이다<br/>\n<code class=\"language-text\">Middleware</code>가 요청 - 응답 사이에 엑세스 권한을 갖는 함수라면<br/>\n<code class=\"language-text\">Afterware</code>는 어플리케이션의 모든 프로세스가 끝난 뒤 응답 직전에 실행되는 함수이다<br/></p>\n<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQ4y52T227CMAyG+/5vNu2SO7YJCcHKqQ0llCY0jacvmqNAudksWY5//3F8aCvnXESGYYhN08S2bZMaY+I4jnGaphhCyIpPbLFYJF2v1w+c6n6/CzKOo1wuF9lut3I4HNI5xiiv5Ha7SV3Xstls5Hw+P/BIiJe167pI1eq/EnDvfbTWzni5QnghBDmdTtJ1XcbK10sfDlzulLGcECG42+2kbdtMek6kFg7clwmZH1YV33ufzyrTNKUEaHlWP81QS2cJ+/0+Jbher3I8HhPGgvQCcY1hSwxe3/dS4bCpYRjEGJNIzrkZRju0qRgWvMS4V1EFDombpknV8FlALDEu0wkxMOwzRuI/V6iPDc4L69DkYKlCZkj/1tq0NZ0hs1FMN5m2+Tt8b4z09ffs06qoQjfKC1RDUs4lxqVkURHpvz7FvL9JDCHH0Er+Kc576ayd4RX/Lu3RGspZ/dI+62q1ko/lchb/AVWBP3cJnu/2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Server_Process.png\"\n        title=\"Server_Process.png\"\n        src=\"/static/a8db43ba07f6cd354ad6cb3669cd5ddc/37523/Server_Process.png\"\n        srcset=\"/static/a8db43ba07f6cd354ad6cb3669cd5ddc/e9ff0/Server_Process.png 180w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/f21e7/Server_Process.png 360w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/37523/Server_Process.png 720w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/302a4/Server_Process.png 1080w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/690c6/Server_Process.png 1201w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>Afterware 이해를 돕기 위한 그림</p>\n</blockquote>\n<br/>\n<p>왼쪽은 일반적인 Express Process이다. 이 경우에 Express 디자인 패턴이 적용 돼<br/>\n<code class=\"language-text\">Router</code> -> <code class=\"language-text\">Controller</code> -> <code class=\"language-text\">Service</code> 순으로 실행이 되며 Service가 실행된 뒤 바로 Client에 요청한 데이터를 응답 해준다.<br/>\n그리고 오른쪽 프로세스 처럼 <code class=\"language-text\">Afterware</code>를 적용했을 때 Service가 끝이나면 <code class=\"language-text\">Afterware</code>함수를 거쳐 응답이 된다.<br/></p>\n<br/>\n<h2 id=\"-사용하는-이유\" style=\"position:relative;\"><a href=\"#-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\" 사용하는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎓 사용하는 이유</h2>\n<br/>\n<p>현재 모든 데이터 요청마다 Access, Refresh Token을 받아와 검증을 진행하는데 만약 Access Token 이 만료되었다면 <code class=\"language-text\">데이터 요청(Token 만료)</code> -> <code class=\"language-text\">Access Token 재발급</code> -> <code class=\"language-text\">데이터 요청</code> 처럼 총 3번의 API 요청이 있게 된다.<br/>\n이렇게 요청의 횟수가 늘어나면 그만큼 리소스 소모가 심해져 성능상 문제가 생길 수 있다.<br/></p>\n<br/>\n<p>이런 형식에서 탈피하고자 원래는 데이터 요청에 Access Token이 만료 되었다면 <code class=\"language-text\">Service</code>단이 끝날 때 Access Token을 재발행 해 응답값에 같이 넣어주는 로직을 짜려했는데, 모든 함수마다 다 추가를 해야했다.<br/>\n그런 불편함을 느끼던 중 깔때기에 아이디어를 얻어 실행중인 모든 로직의 마지막을 한 함수로 모아 응답을 시켜주면 좋겠다 생각을 해 사용하게 되었다.<br/></p>\n<br/>\n<h3 id=\"-장점\" style=\"position:relative;\"><a href=\"#-%EC%9E%A5%EC%A0%90\" aria-label=\" 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👍 장점</h3>\n<ul>\n<li>모든 응답이 깔때기처럼 한곳으로 모여 처리가 돼 유지보수가 쉽다.</li>\n<li>위 이유로 JWT 재발급을 쉽게 처리 할 수 있다.</li>\n<li>Node.js는 싱글 스레드라 에러가 나면 서버가 다운되는데, <code class=\"language-text\">Afterware</code>를 도입한다면 어디에서 오류가 터지던 예상치 못한 에러 핸들링이 가능하다.</li>\n</ul>\n<br/>\n<blockquote>\n<p>이부분은 <a href=\"https://seongsu.me/express-error-middleware\">Express 에러 핸들링</a>를 참고하자</p>\n</blockquote>\n<br/>\n<h3 id=\"-단점\" style=\"position:relative;\"><a href=\"#-%EB%8B%A8%EC%A0%90\" aria-label=\" 단점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👎 단점</h3>\n<ul>\n<li>아무 레퍼런스가 없어 직접 구현해야한다. (진짜 하나도 없고 개념도 생소하다)</li>\n<li>아무래도 틀이 정해져 있다 보니 한정적으로 사용할 수 밖에 없다.</li>\n<li>개발하면서 이게 맞나? 싶다</li>\n</ul>\n<br/>\n<h2 id=\"-적용해-보기\" style=\"position:relative;\"><a href=\"#-%EC%A0%81%EC%9A%A9%ED%95%B4-%EB%B3%B4%EA%B8%B0\" aria-label=\" 적용해 보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🚀 적용해 보기</h2>\n<br/>\n<p><code class=\"language-text\">modules/afterware.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Request<span class=\"token punctuation\">,</span> Response<span class=\"token punctuation\">,</span> NextFunction <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">afterware</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>fn<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> next<span class=\"token operator\">:</span> NextFunction<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>임시로 짜여진 Afterware 코드이다</p>\n</blockquote>\n<br/>\n<p>일단 <code class=\"language-text\">Promise.resolve</code>로 내부 function을 감싸준다.<br/></p>\n<blockquote>\n<p>내부 function은 controller 함수이다.</p>\n</blockquote>\n<p>controller단에서 정상적으로 종료되고 body값을 리턴해 준다면 그대로 Response를 해준다.<br/>\n만약 controller단에서 오류가 났다면 catch문으로 코드가 흐를 것이고 <code class=\"language-text\">next(err)</code> 함수가 실행이 돼 <code class=\"language-text\">Error Middleware</code> 로 넘어간다.</p>\n<br/>\n<p><code class=\"language-text\">routes/users.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getUser <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@controllers/user/info\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> afterware <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/afterware\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> jwtVeriry <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/auth\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> router<span class=\"token operator\">:</span> Router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users/:userId\"</span><span class=\"token punctuation\">,</span> jwtVerify<span class=\"token punctuation\">,</span> <span class=\"token function\">afterware</span><span class=\"token punctuation\">(</span>getUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p><code class=\"language-text\"> http://localhost:5000/users/123</code> 주소로 API 요청이 들어왔다고 가정해 보자.<br/>\n위 코드에서 <strong>jetVerify</strong> 미들웨어에서 문제가 없다면, <strong>getUser</strong> 함수가 호출될 것이다.<br/>\n그 뒤 <strong>getUser</strong> 내부 로직이 모두 실행 된 뒤 <strong>getUser</strong>를 감싸고 있는 <code class=\"language-text\">afterware</code> 함수가 실행이 돼 <strong>getUser</strong>에서 return 된 데이터를 Response 해줄 것이다.<br/></p>\n<br/>\n<p>내가 여기서 만드려고 하는 부분은 <strong>jwtVerify</strong>에서 Token 위변조가 안되었고 DB에 저장되어있는 Refresh Token 검증도 성공했으며 오직 Access Token이 만료 되었다는 신호가 왔을 때 만료되었다는 응답을 보내는것이 아닌, <code class=\"language-text\">afterware</code> 함수에서 새로 Access, Refresh를 발급해 주는 코드를 짜려 한다.<br/></p>\n<br/>\n<p>위 장점에도 서술했지만 이런 방식을 선택했을 때 예상치 못한 에러 처리에 대한 부담감도 덜 수 있고 모든 응답 Process를 획일적으로 관리 해 유지보수를 보다 쉽게 하려 한다.<br/></p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-afterware-%EB%9E%80\">🤔 Afterware 란?</a></p>\n</li>\n<li>\n<p><a href=\"#-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\">🎓 사용하는 이유</a></p>\n<ul>\n<li><a href=\"#-%EC%9E%A5%EC%A0%90\">👍 장점</a></li>\n<li><a href=\"#-%EB%8B%A8%EC%A0%90\">👎 단점</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%A0%81%EC%9A%A9%ED%95%B4-%EB%B3%B4%EA%B8%B0\">🚀 적용해 보기</a></p>\n</li>\n</ul>\n</div>\n<br/>\n<br/>","frontmatter":{"date":"January 07, 2022","title":"Express Afterware 도입","categories":"Node.js Express","author":"seongsu","emoji":"8️⃣"},"fields":{"slug":"/express-afterware/"}},"prev":{"id":"24ee1439-a6bd-5d83-a1aa-ea2f6f8a6358","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIklEQVQoz5WST0/CQBDF+9U9EWMgGEhM/ATejCetXLl556DZGv4WUiBuaCnddudn2gUsiRGcZHY3b2fevJldj9JEqg2rIf6gbrJ5LxekHveHeSKCFHmVIP4dol7YZBb9tXYk6hl5vXf3RY61tvIqr+aunuBVh3xP2Glj1YhVkrAIQ7ZlcDBCOrdnlR1IvSN7WbVxhSwj5qsV08mExBiKRQjNBlEU0e/36fV6+L6P1rryOI5PFR5ll0D7BjsPWccxyyhis9tRhFNoXZNZIZzN+AwCBoMBSZKQpinGmN9aNo6w20SUYq414+GQrMSUQrqtQ2OXtSy2cODbAxI8YQSydOsig0eH/+dRTornula1VK+58Mc4hRxnWJtlDftpZ6/kDPM3H6637KPjZfIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"typeorm.png\"\n        title=\"typeorm.png\"\n        src=\"/static/e4b90acf02bd52801818ca0004fdd1f1/37523/typeorm.png\"\n        srcset=\"/static/e4b90acf02bd52801818ca0004fdd1f1/e9ff0/typeorm.png 180w,\n/static/e4b90acf02bd52801818ca0004fdd1f1/f21e7/typeorm.png 360w,\n/static/e4b90acf02bd52801818ca0004fdd1f1/37523/typeorm.png 720w,\n/static/e4b90acf02bd52801818ca0004fdd1f1/00d43/typeorm.png 1000w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h2 id=\"ullia-hrefhttpsseongsumetypeorm-virtual-column-1-target_blanktypeorm-virtual-column-설정-1aliul\" style=\"position:relative;\"><a href=\"#ullia-hrefhttpsseongsumetypeorm-virtual-column-1-target_blanktypeorm-virtual-column-%EC%84%A4%EC%A0%95-1aliul\" aria-label=\"ullia hrefhttpsseongsumetypeorm virtual column 1 target_blanktypeorm virtual column 설정 1aliul permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><ul><li><a href=\"https://seongsu.me/typeorm-virtual-column-1\" target=\"_blank\">Typeorm Virtual Column 설정 (1)</a></li></ul></h2>\n<br/>\n<br/>\n<p>이전 포스팅에서 <code class=\"language-text\">getMany()</code>함수와 <code class=\"language-text\">getRawMany()</code>함수의 차이점을 알아보게 되었는데<br/>\n이번 포스팅에선 가상컬럼을 사용하며 join시 위 함수의 문제와 해결법을 포스팅 해보려 한다.<br/></p>\n<br/>\n<h2 id=\"-custom-virtual-column을-사용해야-하는-이유\" style=\"position:relative;\"><a href=\"#-custom-virtual-column%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%B4%EC%95%BC-%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\" custom virtual column을 사용해야 하는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>😵‍💫 Custom Virtual Column을 사용해야 하는 이유</h2>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// station id 1 주변 맛집</span>\n<span class=\"token punctuation\">[</span>\n    Shops <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"동찬이네\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Shops <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"사왕이네\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Shops <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n        stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"승한이네\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// station id 2 주변 맛집</span>\n<span class=\"token punctuation\">[</span>\n    Shops <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"크래프트 한스\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Shops <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n        stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"큰통치킨\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Shops <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n        stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"BBQ\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<br/>\n<p>예를들어 위처럼 버스 정류소와 주변 맛집이 정류소 pk를 통해 foreign key로 연결이 되어있다 가정해 보자.<br/></p>\n<br/>\n<p>이렇게 정류소와 주변 맛집의 관계가 맺어져 있는 상황에서 현재 거리 기준 2km 이내 정류소 주변 맛집을 조회하는 쿼리를 실행하면 어떻게 될까?<br/></p>\n<br/>\n<h3 id=\"span-stylecolor-redgetrawmany의-문제span\" style=\"position:relative;\"><a href=\"#span-stylecolor-redgetrawmany%EC%9D%98-%EB%AC%B8%EC%A0%9Cspan\" aria-label=\"span stylecolor redgetrawmany의 문제span permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><span style=\"color: red\">getRawMany()의 문제</span></h3>\n<p>지금 보니 <code class=\"language-text\">getRawMany()</code>함수를 사용하니 가상 컬럼 효과를 낸 것 같은데 해결된거 아니냐? 할 수 있다.<br/>\n그런데 문제는 지금부터이다. 여기서 <code class=\"language-text\">inner join</code> 또는 <code class=\"language-text\">left join</code>을 할 경우<br/></p>\n<br/>\n<p><code class=\"language-text\">getRawMany()함수로 join &amp; 가상컬럼</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token punctuation\">[</span>\n    Stations <span class=\"token punctuation\">{</span>\n        stations_id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        stations_station<span class=\"token operator\">:</span> <span class=\"token string\">\"동대문역 2번출구 정류소\"</span><span class=\"token punctuation\">,</span>\n        stations_latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57198805</span><span class=\"token punctuation\">,</span>\n        stations_longitude<span class=\"token operator\">:</span> <span class=\"token number\">127.0117451</span><span class=\"token punctuation\">,</span>\n        shops_id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        shops_stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        shops_shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"동찬이네\"</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">0.4228400907307967</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Stations <span class=\"token punctuation\">{</span>\n        stations_id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        stations_station<span class=\"token operator\">:</span> <span class=\"token string\">\"동대문역 2번출구 정류소\"</span><span class=\"token punctuation\">,</span>\n        stations_latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57198805</span><span class=\"token punctuation\">,</span>\n        stations_longitude<span class=\"token operator\">:</span> <span class=\"token number\">127.0117451</span><span class=\"token punctuation\">,</span>\n        shops_id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        shops_stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        shops_shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"사왕이네\"</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">0.4228400907307967</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token operator\">...</span>\n\n    Stations <span class=\"token punctuation\">{</span>\n        stations_id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        stations_station<span class=\"token operator\">:</span> <span class=\"token string\">\"원남동 사거리 정류소\"</span><span class=\"token punctuation\">,</span>\n        stations_latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57578617</span><span class=\"token punctuation\">,</span>\n        stations_longitude<span class=\"token operator\">:</span> <span class=\"token number\">126.998124</span><span class=\"token punctuation\">,</span>\n        shops_id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n        shops_stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        shops_shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"큰통치킨\"</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">1.5482886513847316</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Stations <span class=\"token punctuation\">{</span>\n        stations_id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        stations_station<span class=\"token operator\">:</span> <span class=\"token string\">\"원남동 사거리 정류소\"</span><span class=\"token punctuation\">,</span>\n        stations_latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57578617</span><span class=\"token punctuation\">,</span>\n        stations_longitude<span class=\"token operator\">:</span> <span class=\"token number\">126.998124</span><span class=\"token punctuation\">,</span>\n        shops_id<span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n        shops_stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        shops_shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"BBQ\"</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">1.5482886513847316</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<br/>\n<p>위처럼 <code class=\"language-text\">distance</code>를 추가해 조회 할 경우<br/>\n원래 대로면 부모 객체 안에 join된 객체들이 배열을 이뤄 지정한 key의 배열로 저장이 되어야 한다.<br/>\n하지만 <code class=\"language-text\">getRawMany()</code>를 사용하면 부모객체와의 의존성이 모두 사라지며 join된 객체 하나하나가 독립적으로 조회된다.<br/>\n여기서 Typeorm 원시 쿼리 조회의 문제가 나온다.<br/></p>\n<br/>\n<h3 id=\"span-stylecolor-redgetmany의-문제span\" style=\"position:relative;\"><a href=\"#span-stylecolor-redgetmany%EC%9D%98-%EB%AC%B8%EC%A0%9Cspan\" aria-label=\"span stylecolor redgetmany의 문제span permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><span style=\"color: red\">getMany()의 문제</span></h3>\n<br/>\n<p>그럼 <code class=\"language-text\">getMany()</code>함수를 사용하면 되는것 아니냐?<br/>\n<a href=\"http://localhost:8000/typeorm-virtual-column-1/#code-classlanguage-textgetmany-%EC%82%AC%EC%9A%A9-%EC%8B%9Ccode\">이전 포스팅</a>에서 봤던 것 처럼 <code class=\"language-text\">distance</code>를 출력하고 싶은데 안나오는 문제가 있어 자세히 알아볼 필요가 없다.<br/></p>\n<br/>\n<h2 id=\"-custom-virtual-column을-사용해-보자\" style=\"position:relative;\"><a href=\"#-custom-virtual-column%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%B4-%EB%B3%B4%EC%9E%90\" aria-label=\" custom virtual column을 사용해 보자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤩 Custom Virtual Column을 사용해 보자</h2>\n<br/>\n<p>우리가 만들 가상 컬럼은 위 문제를 완벽히 해결해 줄 것이다.<br/></p>\n<blockquote>\n<p>물론 짜기 나름이다 🤪</p>\n</blockquote>\n<br/>\n<p>Custom Virtual Column을 어떻게 사용하냐면<br/>\n첫째로 데코레이터 설정, 가상 컬럼 설정, 그 뒤 <code class=\"language-text\">getMany()</code>, <code class=\"language-text\">getRawMany()</code>를 대체할 함수 제작이다.<br/>\n그럼 <code class=\"language-text\">addSelect()</code>함수가 호출 될 때 alias 된 컬럼명으로 데코레이터가 등록된 컬럼이 적용될 것이다.<br/></p>\n<br/>\n<ul>\n<li>\n<p><a href=\"https://typescript-kr.github.io/pages/decorators.html\">https://typescript-kr.github.io/pages/decorators.html</a><br/></p>\n<p>먼저 위 링크에서 데코레이터 &#x26; 메타데이터에 관해 알아보자<br/></p>\n</li>\n</ul>\n<br/>\n<p>그 뒤 <code class=\"language-text\">reflect-metadata</code>설치가 완료 되었고 <code class=\"language-text\">tsconfig.json</code>에 메타데이터 설정이 완료 되었다면 데코레이터를 만들어 주자.</p>\n<br/>\n<h3 id=\"code-classlanguage-textmodulesdecoratortscode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textmodulesdecoratortscode\" aria-label=\"code classlanguage textmodulesdecoratortscode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@modules/decorator.ts</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token string\">\"reflect-metadata\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COLUMN_KEY</span> <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VIRTUAL_COLUMN\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">VirtualColumn</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> PropertyDecorator <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> propertyKey<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> metaInfo <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">getMetadata</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COLUMN_KEY</span><span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        metaInfo<span class=\"token punctuation\">[</span>propertyKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> name <span class=\"token operator\">??</span> propertyKey<span class=\"token punctuation\">;</span>\n\n        Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">defineMetadata</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COLUMN_KEY</span><span class=\"token punctuation\">,</span> metaInfo<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>데코레이터 함수 작성이 완료되었으면 Entity에 바로 적용하자!<br/></p>\n<br/>\n<h3 id=\"code-classlanguage-textentitiesstationstscode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textentitiesstationstscode\" aria-label=\"code classlanguage textentitiesstationstscode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@entities/stations.ts</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Entity<span class=\"token punctuation\">,</span> PrimaryGeneratedColumn<span class=\"token punctuation\">,</span> Column <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"typeorm\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> VirtualColumn <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/decorator.ts\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Entity</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stations\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Stations</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">PrimaryGeneratedColumn</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    id<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Column</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"varchar\"</span><span class=\"token punctuation\">)</span>\n    station<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Column</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"double\"</span><span class=\"token punctuation\">)</span>\n    latitude<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Column</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"double\"</span><span class=\"token punctuation\">)</span>\n    longitude<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 데코레이터는 distance라는 이름을 가진 컬럼으로 인식하게 된다.</span>\n    <span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">VirtualColumn</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    distance<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>이제 Express 서버가 실행되며 Typeorm이 연결될 때 VirtualColumn()도 같이 적용된다.<br/>\n그 뒤 우리가 원하는 결과를 얻기 위해 <code class=\"language-text\">getRawMany()</code>함수를 커스텀 해보자.<br/></p>\n<br/>\n<h3 id=\"code-classlanguage-textmodulesquerybuildertscode\" style=\"position:relative;\"><a href=\"#code-classlanguage-textmodulesquerybuildertscode\" aria-label=\"code classlanguage textmodulesquerybuildertscode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">@modules/queryBuilder.ts</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SelectQueryBuilder <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"typeorm\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"reflect-metadata\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">declare</span> <span class=\"token keyword\">module</span> <span class=\"token string\">\"typeorm\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">SelectQueryBuilder<span class=\"token operator\">&lt;</span>Entity<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">getAroundShop</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">:</span> SelectQueryBuilder<span class=\"token operator\">&lt;</span>Entity<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>Entity<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COLUMN_KEY</span> <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"VIRTUAL_COLUMN\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nSelectQueryBuilder<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getAroundShop</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 먼저 원시 데이터 조회 결과를 얻어온다</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> entities<span class=\"token punctuation\">,</span> raw <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRawAndEntities</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> items <span class=\"token operator\">=</span> entities<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>entitiy<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 원시 결과에서 필요없는 데이터를 쳐내기 위해 반복문을 돌려준다.</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>flag <span class=\"token operator\">===</span> raw<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"staions_id\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            idx<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 앞전에 작성한 데코레이터를 COLUMN_KEY로 인식하게 한다.</span>\n        <span class=\"token keyword\">const</span> metaInfo <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">getMetadata</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COLUMN_KEY</span><span class=\"token punctuation\">,</span> entitiy<span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> item <span class=\"token operator\">=</span> raw<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>propertyKey<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">]</span> <span class=\"token keyword\">of</span> Object<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">entries</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>metaInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            entitiy<span class=\"token punctuation\">[</span>propertyKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> item<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        flag <span class=\"token operator\">=</span> item<span class=\"token punctuation\">[</span><span class=\"token string\">\"stations_id\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> entitiy<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// distance를 포함한 데이터를 반환해준다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>items<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>이렇게 되면 기존 Typeorm의 <code class=\"language-text\">getRawMany()</code>의 기능과 거의 비슷하게 만든 <code class=\"language-text\">getAroundShop()</code>함수가 만들어 졌다.<br/>\n이렇게 되면 원래 원했던 부모 객체 안에 join된 객체들이 배열을 이뤄 반환이 될 것이다.<br/></p>\n<br/>\n<h3 id=\"code-classlanguage-textgetaroundshop-사용-시code\" style=\"position:relative;\"><a href=\"#code-classlanguage-textgetaroundshop-%EC%82%AC%EC%9A%A9-%EC%8B%9Ccode\" aria-label=\"code classlanguage textgetaroundshop 사용 시code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">getAroundShop() 사용 시</code></h3>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getRepository <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"typeorm\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getAroundShop <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/queryBuilder\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Stations <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@entities/stations\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Shops <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@entities/shops\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n    lat: 37.57418192,\n    lon: 127.015664,\n    radius(기준 km): 2\n*/</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">aroundStation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>lat<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> lon<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> radius<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>Stations<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">createQueryBuilder</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stations\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">addSelect</span><span class=\"token punctuation\">(</span>\n                <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">6371 * acos(cos(radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lat<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) * cos(radians(latitude)) * cos(radians(longitude) - radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lon<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) + sin(radians(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lat<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)) * sin(radians(latitude)))</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"distance\"</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">leftJoinAndSelect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stations.shops\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"shops\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">having</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">distance &lt;= </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>radius<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"distance\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ASC\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">getAroundShop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">aroundStation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>Entity join하는 방법은 <a href=\"https://typeorm.io\">Typeorm 공식문서</a>를 참조하자!</p>\n</blockquote>\n<br/>\n<h2 id=\"-가상-컬럼을-통한-데이터-조회\" style=\"position:relative;\"><a href=\"#-%EA%B0%80%EC%83%81-%EC%BB%AC%EB%9F%BC%EC%9D%84-%ED%86%B5%ED%95%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A1%B0%ED%9A%8C\" aria-label=\" 가상 컬럼을 통한 데이터 조회 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🥳 가상 컬럼을 통한 데이터 조회</h2>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token punctuation\">[</span>\n    Stations <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        station<span class=\"token operator\">:</span> <span class=\"token string\">\"동대문역 2번출구 정류소\"</span><span class=\"token punctuation\">,</span>\n        latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57198805</span><span class=\"token punctuation\">,</span>\n        longitude<span class=\"token operator\">:</span> <span class=\"token number\">127.0117451</span><span class=\"token punctuation\">,</span>\n        shops<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"동찬이네\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n                stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"사왕이네\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n                stationId<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"승한이네\"</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">0.4228400907307967</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Stations <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        station<span class=\"token operator\">:</span> <span class=\"token string\">\"원남동 사거리 정류소\"</span><span class=\"token punctuation\">,</span>\n        latitude<span class=\"token operator\">:</span> <span class=\"token number\">37.57578617</span><span class=\"token punctuation\">,</span>\n        longitude<span class=\"token operator\">:</span> <span class=\"token number\">126.998124</span><span class=\"token punctuation\">,</span>\n        shops<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n                stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n                shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"크래프트 한스\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n                stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n                shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"큰통치킨\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n                id<span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n                stationId<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n                shopName<span class=\"token operator\">:</span> <span class=\"token string\">\"BBQ\"</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        distance<span class=\"token operator\">:</span> <span class=\"token number\">1.5482886513847316</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<br/>\n<p>이로써 테이블에 존재하지 않는 특정 데이터를 포함해 조회하는 로직을 완성할 수 있게 되었다.<br/>\n이게 특별한 기능은 아닌것 같은데 Typeorm에서 정식으로 지원해 주지 않는 바람에 몇일 개고생을 해서 찾고 구현을 하게 되었다.<br/>\n후…😑 왜 이렇게 필요하고 이게 안돼? 라는 기능이 공식 지원이 안돼 개고생을 해야하는지 모르겠지만… 어쨋든 결과가 좋았으니 된것 같다…😅<br/></p>\n<blockquote>\n<p>0.2.37 버전에서 지원 해준다 했으면서 아직도 안해주네…</p>\n</blockquote>\n<br/>\n<h2 id=\"-참고-자료\" style=\"position:relative;\"><a href=\"#-%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C\" aria-label=\" 참고 자료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>📚 참고 자료</h2>\n<ul>\n<li>Virtual Column solutions for TypeORM</li>\n</ul>\n<blockquote>\n<p><a href=\"https://pietrzakadrian.com/blog/virtual-column-solutions-for-typeorm\">https://pietrzakadrian.com/blog/virtual-column-solutions-for-typeorm</a></p>\n</blockquote>\n<br/>\n<br/>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#ullia-hrefhttpsseongsumetypeorm-virtual-column-1-target_blanktypeorm-virtual-column-%EC%84%A4%EC%A0%95-1aliul\"><ul><li><a href=\"https://seongsu.me/typeorm-virtual-column-1\" target=\"_blank\">Typeorm Virtual Column 설정 (1)</a></li></ul></a></p>\n</li>\n<li>\n<p><a href=\"#-custom-virtual-column%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%B4%EC%95%BC-%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\">😵‍💫 Custom Virtual Column을 사용해야 하는 이유</a></p>\n<ul>\n<li><a href=\"#span-stylecolor-redgetrawmany%EC%9D%98-%EB%AC%B8%EC%A0%9Cspan\"><span style=\"color: red\">getRawMany()의 문제</span></a></li>\n<li><a href=\"#span-stylecolor-redgetmany%EC%9D%98-%EB%AC%B8%EC%A0%9Cspan\"><span style=\"color: red\">getMany()의 문제</span></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-custom-virtual-column%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%B4-%EB%B3%B4%EC%9E%90\">🤩 Custom Virtual Column을 사용해 보자</a></p>\n<ul>\n<li><a href=\"#modulesdecoratorts\"><code class=\"language-text\">@modules/decorator.ts</code></a></li>\n<li><a href=\"#entitiesstationsts\"><code class=\"language-text\">@entities/stations.ts</code></a></li>\n<li><a href=\"#modulesquerybuilderts\"><code class=\"language-text\">@modules/queryBuilder.ts</code></a></li>\n<li><a href=\"#getaroundshop-%EC%82%AC%EC%9A%A9-%EC%8B%9C\"><code class=\"language-text\">getAroundShop() 사용 시</code></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EA%B0%80%EC%83%81-%EC%BB%AC%EB%9F%BC%EC%9D%84-%ED%86%B5%ED%95%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A1%B0%ED%9A%8C\">🥳 가상 컬럼을 통한 데이터 조회</a></p>\n</li>\n<li>\n<p><a href=\"#-%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C\">📚 참고 자료</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"January 17, 2022","title":"Typeorm Virtual Column 설정 (2)","categories":"Node.js Express","author":"seongsu","emoji":"🔟"},"fields":{"slug":"/typeorm-virtual-column-2/"}},"site":{"siteMetadata":{"siteUrl":"https://seongsu.me","comments":{"utterances":{"repo":"nfl1ryxditimo12/nfl1ryxditimo12.github.io"}}}}},"pageContext":{"slug":"/typeorm-virtual-column-1/","nextSlug":"/express-afterware/","prevSlug":"/typeorm-virtual-column-2/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}
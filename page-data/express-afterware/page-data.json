{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/express-afterware/",
    "result": {"data":{"cur":{"id":"0d46e7d8-88c4-58d6-8b77-a2753cfb0a17","html":"<p>오늘은 생소하고 아무도 사용 안하는 <code class=\"language-text\">Afterware</code> 개념을 도입해 모든 API 응답에 JWT가 만료되었다면 새로 발행해주는 코드 짜고자 한다.<br/>\n원래 Express에 <code class=\"language-text\">Middleware</code> 개념이 있고 실제로 지원이 된다.<br/>\n하지만 현재 구현하는 로직 상 <code class=\"language-text\">Afterware</code>를 사용하면 유지보수에 상당히 도움이 될 것 같다<br/></p>\n<br/>\n<h2 id=\"-afterware-란\" style=\"position:relative;\"><a href=\"#-afterware-%EB%9E%80\" aria-label=\" afterware 란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Afterware 란?</h2>\n<br/>\n<p>사실 Express 프레임워크에 <code class=\"language-text\">Afterware</code>란 기능은 없다<br/>\n그냥 맨 마지막에 실행되는 함수라 이렇게 부르는 것일 뿐이다<br/>\n<code class=\"language-text\">Middleware</code>가 요청 - 응답 사이에 엑세스 권한을 갖는 함수라면<br/>\n<code class=\"language-text\">Afterware</code>는 어플리케이션의 모든 프로세스가 끝난 뒤 응답 직전에 실행되는 함수이다<br/></p>\n<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaElEQVQ4y52T227CMAyG+/5vNu2SO7YJCcHKqQ0llCY0jacvmqNAudksWY5//3F8aCvnXESGYYhN08S2bZMaY+I4jnGaphhCyIpPbLFYJF2v1w+c6n6/CzKOo1wuF9lut3I4HNI5xiiv5Ha7SV3Xstls5Hw+P/BIiJe167pI1eq/EnDvfbTWzni5QnghBDmdTtJ1XcbK10sfDlzulLGcECG42+2kbdtMek6kFg7clwmZH1YV33ufzyrTNKUEaHlWP81QS2cJ+/0+Jbher3I8HhPGgvQCcY1hSwxe3/dS4bCpYRjEGJNIzrkZRju0qRgWvMS4V1EFDombpknV8FlALDEu0wkxMOwzRuI/V6iPDc4L69DkYKlCZkj/1tq0NZ0hs1FMN5m2+Tt8b4z09ffs06qoQjfKC1RDUs4lxqVkURHpvz7FvL9JDCHH0Er+Kc576ayd4RX/Lu3RGspZ/dI+62q1ko/lchb/AVWBP3cJnu/2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Server_Process.png\"\n        title=\"Server_Process.png\"\n        src=\"/static/a8db43ba07f6cd354ad6cb3669cd5ddc/37523/Server_Process.png\"\n        srcset=\"/static/a8db43ba07f6cd354ad6cb3669cd5ddc/e9ff0/Server_Process.png 180w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/f21e7/Server_Process.png 360w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/37523/Server_Process.png 720w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/302a4/Server_Process.png 1080w,\n/static/a8db43ba07f6cd354ad6cb3669cd5ddc/690c6/Server_Process.png 1201w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<blockquote>\n<p>Afterware 이해를 돕기 위한 그림</p>\n</blockquote>\n<br/>\n<p>왼쪽은 일반적인 Express Process이다. 이 경우에 Express 디자인 패턴이 적용 돼<br/>\n<code class=\"language-text\">Router</code> -> <code class=\"language-text\">Controller</code> -> <code class=\"language-text\">Service</code> 순으로 실행이 되며 Service가 실행된 뒤 바로 Client에 요청한 데이터를 응답 해준다.<br/>\n그리고 오른쪽 프로세스 처럼 <code class=\"language-text\">Afterware</code>를 적용했을 때 Service가 끝이나면 <code class=\"language-text\">Afterware</code>함수를 거쳐 응답이 된다.<br/></p>\n<br/>\n<h2 id=\"-사용하는-이유\" style=\"position:relative;\"><a href=\"#-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\" 사용하는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🎓 사용하는 이유</h2>\n<br/>\n<p>현재 모든 데이터 요청마다 Access, Refresh Token을 받아와 검증을 진행하는데 만약 Access Token 이 만료되었다면 <code class=\"language-text\">데이터 요청(Token 만료)</code> -> <code class=\"language-text\">Access Token 재발급</code> -> <code class=\"language-text\">데이터 요청</code> 처럼 총 3번의 API 요청이 있게 된다.<br/>\n이렇게 요청의 횟수가 늘어나면 그만큼 리소스 소모가 심해져 성능상 문제가 생길 수 있다.<br/></p>\n<br/>\n<p>이런 형식에서 탈피하고자 원래는 데이터 요청에 Access Token이 만료 되었다면 <code class=\"language-text\">Service</code>단이 끝날 때 Access Token을 재발행 해 응답값에 같이 넣어주는 로직을 짜려했는데, 모든 함수마다 다 추가를 해야했다.<br/>\n그런 불편함을 느끼던 중 깔때기에 아이디어를 얻어 실행중인 모든 로직의 마지막을 한 함수로 모아 응답을 시켜주면 좋겠다 생각을 해 사용하게 되었다.<br/></p>\n<br/>\n<h3 id=\"-장점\" style=\"position:relative;\"><a href=\"#-%EC%9E%A5%EC%A0%90\" aria-label=\" 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👍 장점</h3>\n<ul>\n<li>모든 응답이 깔때기처럼 한곳으로 모여 처리가 돼 유지보수가 쉽다.</li>\n<li>위 이유로 JWT 재발급을 쉽게 처리 할 수 있다.</li>\n<li>Node.js는 싱글 스레드라 에러가 나면 서버가 다운되는데, <code class=\"language-text\">Afterware</code>를 도입한다면 어디에서 오류가 터지던 예상치 못한 에러 핸들링이 가능하다.</li>\n</ul>\n<br/>\n<blockquote>\n<p>이부분은 <a href=\"https://seongsu.me/express-error-middleware\">Express 에러 핸들링</a>를 참고하자</p>\n</blockquote>\n<br/>\n<h3 id=\"-단점\" style=\"position:relative;\"><a href=\"#-%EB%8B%A8%EC%A0%90\" aria-label=\" 단점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>👎 단점</h3>\n<ul>\n<li>아무 레퍼런스가 없어 직접 구현해야한다. (진짜 하나도 없고 개념도 생소하다)</li>\n<li>아무래도 틀이 정해져 있다 보니 한정적으로 사용할 수 밖에 없다.</li>\n<li>개발하면서 이게 맞나? 싶다</li>\n</ul>\n<br/>\n<h2 id=\"-적용해-보기\" style=\"position:relative;\"><a href=\"#-%EC%A0%81%EC%9A%A9%ED%95%B4-%EB%B3%B4%EA%B8%B0\" aria-label=\" 적용해 보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🚀 적용해 보기</h2>\n<br/>\n<p><code class=\"language-text\">modules/afterware.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Request<span class=\"token punctuation\">,</span> Response<span class=\"token punctuation\">,</span> NextFunction <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">afterware</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>fn<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> next<span class=\"token operator\">:</span> NextFunction<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>임시로 짜여진 Afterware 코드이다</p>\n</blockquote>\n<br/>\n<p>일단 <code class=\"language-text\">Promise.resolve</code>로 내부 function을 감싸준다.<br/></p>\n<blockquote>\n<p>내부 function은 controller 함수이다.</p>\n</blockquote>\n<p>controller단에서 정상적으로 종료되고 body값을 리턴해 준다면 그대로 Response를 해준다.<br/>\n만약 controller단에서 오류가 났다면 catch문으로 코드가 흐를 것이고 <code class=\"language-text\">next(err)</code> 함수가 실행이 돼 <code class=\"language-text\">Error Middleware</code> 로 넘어간다.</p>\n<br/>\n<p><code class=\"language-text\">routes/users.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getUser <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@controllers/user/info\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> afterware <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/afterware\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> jwtVeriry <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/auth\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> router<span class=\"token operator\">:</span> Router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/users/:userId\"</span><span class=\"token punctuation\">,</span> jwtVerify<span class=\"token punctuation\">,</span> <span class=\"token function\">afterware</span><span class=\"token punctuation\">(</span>getUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p><code class=\"language-text\"> http://localhost:5000/users/123</code> 주소로 API 요청이 들어왔다고 가정해 보자.<br/>\n위 코드에서 <strong>jetVerify</strong> 미들웨어에서 문제가 없다면, <strong>getUser</strong> 함수가 호출될 것이다.<br/>\n그 뒤 <strong>getUser</strong> 내부 로직이 모두 실행 된 뒤 <strong>getUser</strong>를 감싸고 있는 <code class=\"language-text\">afterware</code> 함수가 실행이 돼 <strong>getUser</strong>에서 return 된 데이터를 Response 해줄 것이다.<br/></p>\n<br/>\n<p>내가 여기서 만드려고 하는 부분은 <strong>jwtVerify</strong>에서 Token 위변조가 안되었고 DB에 저장되어있는 Refresh Token 검증도 성공했으며 오직 Access Token이 만료 되었다는 신호가 왔을 때 만료되었다는 응답을 보내는것이 아닌, <code class=\"language-text\">afterware</code> 함수에서 새로 Access, Refresh를 발급해 주는 코드를 짜려 한다.<br/></p>\n<br/>\n<p>위 장점에도 서술했지만 이런 방식을 선택했을 때 예상치 못한 에러 처리에 대한 부담감도 덜 수 있고 모든 응답 Process를 획일적으로 관리 해 유지보수를 보다 쉽게 하려 한다.<br/></p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#-afterware-%EB%9E%80\">🤔 Afterware 란?</a></p>\n</li>\n<li>\n<p><a href=\"#-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\">🎓 사용하는 이유</a></p>\n<ul>\n<li><a href=\"#-%EC%9E%A5%EC%A0%90\">👍 장점</a></li>\n<li><a href=\"#-%EB%8B%A8%EC%A0%90\">👎 단점</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-%EC%A0%81%EC%9A%A9%ED%95%B4-%EB%B3%B4%EA%B8%B0\">🚀 적용해 보기</a></p>\n</li>\n</ul>\n</div>\n<br/>\n<br/>","excerpt":"오늘은 생소하고 아무도 사용 안하는  개념을 도입해 모든 API 응답에 JWT가 만료되었다면 새로 발행해주는 코드 짜고자 한다.\n원래 Express에  개념이 있고 실제로 지원이 된다.\n하지만 현재 구현하는 로직 상 를 사용하면 유지보수에 상당히 도움이 될 것 같다 🤔 Afterware 란? 사실 Express 프레임워크에 란 기능은 없다\n그냥 맨 마지막에 실행되는 함수라 이렇게 부르는 것일 뿐이다\n가 요청 - 응답 사이에 엑세스 권한을 갖는 함수라면\n는 어플리케이션의 모든 프로세스가 끝난 뒤 응답 직전에 실행되는 함수이다  Afterware 이해를 돕기 위한 그림 왼쪽은 일반적인 Express Process이다. 이 경우에 Express 디자인 패턴이 적용 돼\n ->  ->  순으로 실행이 되며 Service가 실행된 뒤 바로 Client에 요청한 데이터를 응답 해준다.\n그리고 오른쪽 프로세스 처럼 를 적용했을 때 Service가 끝이나면 함수를 거쳐 응답이 된다. 🎓 사용하는 …","frontmatter":{"date":"January 07, 2022","title":"Express Afterware 도입","categories":"Node.js Express","author":"seongsu","emoji":"8️⃣"},"fields":{"slug":"/express-afterware/"}},"next":{"id":"47e00f98-5c31-5401-aee9-8d62f9339cf0","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtUlEQVQoz61RQQ6CMBDk/x9CQMTgAYO3YjCYIIInoNCCDxjTTUqIAe2Bw2S7293pdNbquw5bwponHedTNMF8ZpFQN0ghMEhJuej7CUu9fxUqsqoscc8yqrVNg6auCbxtJxgRqsb3OOISxzhHEY5BAM91sbNtOu89D47j4OD7eBYFPf7zy1rhI89xTRIwxnAKQ4qqdktTJIzR3auqyAZjD8dhIKghFbWv87qRh5tveY14bQnfCj/fJZ+k6bwZBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"express.png\"\n        title=\"express.png\"\n        src=\"/static/dd36a740e63a97f0f6bd9b47b5ef9ccc/37523/express.png\"\n        srcset=\"/static/dd36a740e63a97f0f6bd9b47b5ef9ccc/e9ff0/express.png 180w,\n/static/dd36a740e63a97f0f6bd9b47b5ef9ccc/f21e7/express.png 360w,\n/static/dd36a740e63a97f0f6bd9b47b5ef9ccc/37523/express.png 720w,\n/static/dd36a740e63a97f0f6bd9b47b5ef9ccc/302a4/express.png 1080w,\n/static/dd36a740e63a97f0f6bd9b47b5ef9ccc/78797/express.png 1125w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br/>\n<h2 id=\"️-custom-error\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-custom-error\" aria-label=\"️ custom error permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>⛔️ Custom Error</h2>\n<br/>\n<p>개발을 하다 보면 자체 여러 클래스가 필요한 경우가 종종 생긴다.<br/>\n네트워크 관련 작업 중 에러가 발생했다면 <code class=\"language-text\">HttpError</code>,<br/>\n데이터베이스 관련 작업 중 에러가 발생했다면 <code class=\"language-text\">DbError</code>,<br/>\n검색 관련 작업 중 에러가 발생했다면 <code class=\"language-text\">NotFoundError</code><br/>\n등등 직접 연관된 에러를 발생시키는게 직관적이기 때문이다.<br/></p>\n<br/>\n<p>나는 API 서버를 제작 중이여서 <code class=\"language-text\">HttpResponseError</code> 위주로 작성 했다.<br/>\n직접 에러 클래스를 만든 경우, 이 에러들은 <code class=\"language-text\">statusCode</code>, <code class=\"language-text\">message</code>, <code class=\"language-text\">stack</code>처럼 여러 프로퍼티를 지원하게 할 수 있다.<br/></p>\n<blockquote>\n<p>물론 이외의 프로퍼티도 지원 하게 만들 수 있다.</p>\n</blockquote>\n<br/>\n<p><code class=\"language-text\">JavaScript</code>에서 <code class=\"language-text\">throw</code>의 인수에 아무런 제약이 없기 때문에 커스텀 에러 클래스는 반드시 <code class=\"language-text\">Error</code>를 상속할 필요가 없다.<br/>\n하지만 <code class=\"language-text\">Error</code>를 상속받아 커스텀 에러 클래스를 만들게 되면 <code class=\"language-text\">obj instanceof Error</code>를 사용해 여러 객체를 식별 할 수 있다는 장점이 있다.</p>\n<blockquote>\n<p>그래서 Error를 상속해서 커스텀 Error 클래스를 만들자</p>\n</blockquote>\n<br/>\n<h3 id=\"-custom-error-제작\" style=\"position:relative;\"><a href=\"#-custom-error-%EC%A0%9C%EC%9E%91\" aria-label=\" custom error 제작 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🛠 Custom Error 제작</h3>\n<br/>\n<p><code class=\"language-text\">modules/apiError.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ApiError</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Error</span> <span class=\"token punctuation\">{</span>\n    statusCode<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n    isFatal<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> message<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> option<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> stack<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> isFatal<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>statuscode <span class=\"token operator\">=</span> statusCode<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isFatal <span class=\"token operator\">=</span> option<span class=\"token punctuation\">.</span>isFatal <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> option<span class=\"token punctuation\">.</span>isFatal<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>option<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stack <span class=\"token operator\">=</span> option<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                Error<span class=\"token punctuation\">.</span><span class=\"token function\">captureStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isFatal <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            Error<span class=\"token punctuation\">.</span><span class=\"token function\">captureStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Api 서버에서 사용하는 Api Custom Error이다</p>\n</blockquote>\n<br/>\n<p>인자로 <code class=\"language-text\">statusCode</code>, <code class=\"language-text\">message</code>를 받아오고 옵션으로 <code class=\"language-text\">stack</code>, <code class=\"language-text\">isFatal</code>을 받아온다<br/></p>\n<blockquote>\n<p>stack은 stackTrace의 반환값이고 isFatal은 심각한 오류일 경우 로깅 &#x26; 슬랙 알림을 위해 넣었다</p>\n</blockquote>\n<br/>\n<p><code class=\"language-text\">message</code>프로퍼티가 부모 생성자에서 설정되게 하기 위해 <code class=\"language-text\">super</code>를 호출해준다<br/>\n그리고 <code class=\"language-text\">statusCode</code> 또한 부모 생성자에 설정해준다.<br/>\n그 뒤 필요에 의해 <code class=\"language-text\">option</code>값이 들어오면 그 값에 대해서도 부모 생성자에 설정해준다.<br/></p>\n<br/>\n<br/>\n<h2 id=\"-error-middleware\" style=\"position:relative;\"><a href=\"#-error-middleware\" aria-label=\" error middleware permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🚫 Error Middleware</h2>\n<br/>\n<p><code class=\"language-text\">Express</code>로 개발을 하다 <strong><code class=\"language-text\">만약 실 서비스에서 생각지 못한 오류로 서버가 종료되면 어떡하지?</code></strong> 라는 생각이 들었던 적 있을것 이다.<br/></p>\n<br/>\n<p>이런 걱정을 할 수 밖에 없는 이유가 <code class=\"language-text\">Node.js</code> 자체가 단일 스레드 플랫폼이다 보니 오류가 날 경우 서비스가 그대로 죽어버리는 문제가 있다.<br/>\n그렇다고 모든 오류에 관해 <code class=\"language-text\">try ... catch</code>문으로 막으면 코드가 보기 좋지 않을 뿐더러 단위/통합 테스트를 빡세게 한다해도 한계가 있기 때문이다.<br/></p>\n<blockquote>\n<p>사실 Node.js는 시스템적으로 non-blocking I/O를 지원하지 않는 호출이 있는 경우, 이를 비동기 처리 하기 위해 내부의 Thread pool(libio)을 별도로 이용해 처리한다고 해서 정확히 말하면 싱글 스레드는 아니다.</p>\n</blockquote>\n<br/>\n<h3 id=\"-그래서-어떻게-해야하나\" style=\"position:relative;\"><a href=\"#-%EA%B7%B8%EB%9E%98%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%B4%EC%95%BC%ED%95%98%EB%82%98\" aria-label=\" 그래서 어떻게 해야하나 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>❓ 그래서 어떻게 해야하나</h3>\n<br/>\n<p>서비스 상 어디서 발생할 지 모르는 에러를 일일히 막는다는 것은 매우 비효율적이며 보기에도 별로 좋지 않고 그렇게 할 필요도 없다.<br/>\n왜냐하면 오류가 난 상황에서 <code class=\"language-text\">Express</code> 미들웨어를 이용하면 손쉽게 처리가 가능하기 때문이다.<br/></p>\n<h4 id=\"span-stylecolor-redmiddleware-란span\" style=\"position:relative;\"><a href=\"#span-stylecolor-redmiddleware-%EB%9E%80span\" aria-label=\"span stylecolor redmiddleware 란span permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><span style=\"color: red;\">Middleware 란?</span></h4>\n<p><code class=\"language-text\">Client</code>에게 요청이 오고 그 요청에 관한 응답을 보내는 중간에 거쳐가는 함수이다.<br/>\n<code class=\"language-text\">Middleware</code> 함수는 req(요청)과 res(응답), 그리고 어플리케이션 요청-응답 사이클 중간에서 필요한 처리를 해주는 함수를 뜻한다.<br/>\n모든 로직이 끝난 후 <code class=\"language-text\">next</code>를 호출하며 미들웨어가 순차적으로 처리되며 모든 미들웨어가 처리되었다면 응답 로직으로 넘어간다.<br/></p>\n<br/>\n<h3 id=\"-error-middleware-작성\" style=\"position:relative;\"><a href=\"#-error-middleware-%EC%9E%91%EC%84%B1\" aria-label=\" error middleware 작성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🚧 Error Middleware 작성</h3>\n<br/>\n<p><code class=\"language-text\">modules/error.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorConverter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>err<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> next<span class=\"token operator\">:</span> NextFunction<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> error <span class=\"token operator\">=</span> err<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>err <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ApiError</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> statusCode <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">||</span> httpStatus<span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">||</span> httpStatus<span class=\"token punctuation\">[</span>statusCode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        error <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiError</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>오류가 났을 때 Custom Error로 변환시켜주는 Middleware</p>\n</blockquote>\n<br/>\n<p>일단 오류가 났다고 가정하면 위 <code class=\"language-text\">errorConverter</code> 미들웨어가 실행이 될 것이다.<br/>\n이 미들웨어는 위에 작성한 일반 <code class=\"language-text\">Error</code>를 <code class=\"language-text\">Custom Error</code>로 변환시키는 작업을 해준다.<br/>\n그 뒤 다음 미들웨어로 <code class=\"language-text\">error</code> 객체를 넘겨준다.<br/></p>\n<br/>\n<p><code class=\"language-text\">modules/error.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>err<span class=\"token operator\">:</span> ApiError<span class=\"token punctuation\">,</span> req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> next<span class=\"token operator\">:</span> NextFunction<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> statusCode<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> stack <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> err<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> code<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span> message<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> stack<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        code<span class=\"token operator\">:</span> statusCode<span class=\"token punctuation\">,</span>\n        message<span class=\"token punctuation\">,</span>\n        stack<span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">.</span>nodeEnv <span class=\"token operator\">!==</span> <span class=\"token string\">\"production\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span>stack <span class=\"token operator\">=</span> stack<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>statusCode <span class=\"token operator\">===</span> httpStatus<span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">slack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> log<span class=\"token operator\">:</span> logger<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>stack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> statusCode<span class=\"token punctuation\">,</span> stack<span class=\"token punctuation\">,</span> message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        logger<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>stack<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>Custom Error로 변환된 Error를 Client에 응답해 주는 미들웨어</p>\n</blockquote>\n<br/>\n<p>일단 <code class=\"language-text\">예상치 못한 오류</code> / <code class=\"language-text\">예상한 오류</code>로 나눠 에러 핸들링을 하였고<br/>\n예상치 못한 오류 <code class=\"language-text\">INTERNAL SERVER ERROR</code>인 경우 제일 높은 단계로 <code class=\"language-text\">logging</code>을 한 뒤 <code class=\"language-text\">Slack Web Hook</code>을 통해 <code class=\"language-text\">Slack</code>으로 오류를 전달해 주는 로직을 짜게 되었다.<br/></p>\n<blockquote>\n<p>심각한 오류가 뜨면 헐레벌떡 컴퓨터를 켜야한다</p>\n</blockquote>\n<p>그 뒤 예상한 오류들은 모두 400번대 <code class=\"language-text\">Https Status Code</code>를 갖고 있어 로깅만 해준다.<br/>\n보통 <code class=\"language-text\">Client</code>에서 잘못된 정보가 온 경우이다.<br/>\n마지막으로 현재 <code class=\"language-text\">statusCode</code>, <code class=\"language-text\">message</code>, <code class=\"language-text\">stack</code>를 응답해 준다.</p>\n<br/>\n<h3 id=\"-error-middleware-적용\" style=\"position:relative;\"><a href=\"#-error-middleware-%EC%A0%81%EC%9A%A9\" aria-label=\" error middleware 적용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🛤 Error Middleware 적용</h3>\n<br/>\n<p>위처럼 <code class=\"language-text\">Middleware</code>를 작성 했다고 오류가 났을 때 미들웨어가 작동되지 않는다.<br/></p>\n<blockquote>\n<p>당연한 소리지만 연결 해줘야지 🤣</p>\n</blockquote>\n<br/>\n<p><code class=\"language-text\">app.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> apiRouter <span class=\"token keyword\">from</span> <span class=\"token string\">\"@routes/index\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> errorConverter<span class=\"token punctuation\">,</span> errorHandler <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/error\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token comment\">// Api Router</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>apiRouter<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> apiRouter<span class=\"token punctuation\">.</span>router<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Error Middleware</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorConverter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>경로의 시작이’@’ 인 이유는 절대경로를 지정했고 <a href=\"https://seongsu.me/nodejs-typescript/\">TypeScript 설정</a>을 참조하자</p>\n</blockquote>\n<br/>\n<p>일단 <code class=\"language-text\">app.ts</code>파일에 <code class=\"language-text\">Error Middleware</code>를 적용시켜준다.<br/>\n이 때 무조건 <code class=\"language-text\">Api Router</code> 밑에 작성해 줘야 정상적으로 작동 한다.<br/></p>\n<blockquote>\n<p>이런다고 미들웨어가 작동하나??? 아니다 또 설정 해줘야 한다.</p>\n</blockquote>\n<br/>\n<p><code class=\"language-text\">modules/error.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">catchError</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>fn<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> next<span class=\"token operator\">:</span> NextFunction<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>특정 코드에서 오류가 났을때 <code class=\"language-text\">try ... catch</code>방식으로 오류를 잡아 <code class=\"language-text\">Error Middleware</code>로 넘겨주는 함수이다.</p>\n<br/>\n<p><code class=\"language-text\">routes/index.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Router <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getInfo <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@controllers/index.ts\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> path<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> router<span class=\"token operator\">:</span> Router <span class=\"token operator\">=</span> <span class=\"token function\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> getInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>밑의 <code class=\"language-text\">controllers/index.ts</code>파일이 어떻게 불러와지는지 이해를 돕는 코드</p>\n</blockquote>\n<br/>\n<p><code class=\"language-text\">controllers/index.ts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Request<span class=\"token punctuation\">,</span> Response<span class=\"token punctuation\">,</span> NextFunction <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"express\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> catchError <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/error\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ApiError <span class=\"token keyword\">from</span> <span class=\"token string\">\"@modules/apiError\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> httpStatus <span class=\"token keyword\">from</span> <span class=\"token string\">\"http-status\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> getInfo <span class=\"token operator\">=</span> <span class=\"token function\">catchError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'1'</span> <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"이게 맞냐?\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiError</span><span class=\"token punctuation\">(</span>httpStatus<span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"틀렸다\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>위 처럼 변수를 받아오는 곳에 <code class=\"language-text\">catchError</code>함수로 감싸준 코드를 작성하고 <code class=\"language-text\">http://localhost:${port}/</code> URL에 <code class=\"language-text\">GET</code> 요청을 날려보자.<br/>\n이 때 문자열 ‘1’은 숫자 1이 아니므로 <code class=\"language-text\">new ApiError</code>이 <code class=\"language-text\">throw</code>될 것 이다.<br/></p>\n<br/>\n<p>그때 일반적인 상황에서 따로 <code class=\"language-text\">try ... catch</code>같은 에러 핸들링을 해주지 않았다면 서버는 즉시 종료 될 것이다.<br/>\n하지만 현재 <code class=\"language-text\">Error Middleware</code>를 적용한 경우 <code class=\"language-text\">Error</code>객체가 <code class=\"language-text\">throw</code>된다 해도 서버가 종료되지 않고 다음 미들웨어로 넘어가 오류가 응답되기 때문에 예상치 못한 오류라도 걱정하지 않고 코드를 짤 수 있게 된다.<br/></p>\n<br/>\n<p>이런 방식으로 <code class=\"language-text\">controller</code>단에 미들웨어를 놔준다면 심각한 오류를 막을 수 있고 유지보수에도 도움이 많이 된다.<br/></p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-custom-error\">⛔️ Custom Error</a></p>\n<ul>\n<li><a href=\"#-custom-error-%EC%A0%9C%EC%9E%91\">🛠 Custom Error 제작</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-error-middleware\">🚫 Error Middleware</a></p>\n<ul>\n<li>\n<p><a href=\"#-%EA%B7%B8%EB%9E%98%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%B4%EC%95%BC%ED%95%98%EB%82%98\">❓ 그래서 어떻게 해야하나</a></p>\n<ul>\n<li><a href=\"#span-stylecolor-redmiddleware-%EB%9E%80span\"><span style=\"color: red;\">Middleware 란?</span></a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-error-middleware-%EC%9E%91%EC%84%B1\">🚧 Error Middleware 작성</a></p>\n</li>\n<li>\n<p><a href=\"#-error-middleware-%EC%A0%81%EC%9A%A9\">🛤 Error Middleware 적용</a></p>\n</li>\n</ul>\n</li>\n</ul>\n</div>\n<br/>\n<br/>","frontmatter":{"date":"January 06, 2022","title":"Express error middleware & Custom error module","categories":"Node.js Express","author":"seongsu","emoji":"7️⃣"},"fields":{"slug":"/express-error-middleware/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://seongsu.me","comments":{"utterances":{"repo":"nfl1ryxditimo12/nfl1ryxditimo12.github.io"}}}}},"pageContext":{"slug":"/express-afterware/","nextSlug":"/express-error-middleware/","prevSlug":""}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}